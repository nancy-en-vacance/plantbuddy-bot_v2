<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PlantBuddy</title>
  <style>
    :root{
      --bg:#F6FBFD;
      --card:#FFFFFF;
      --text:#2A2D34;
      --muted:#4B5563;
      --border:#D7E2E8;
      --accent:#30C5FF;
      --accent2:#5C946E;
      --danger:#D64545;
      --warn:#C57F1E;
      --shadow:0 10px 30px rgba(42,45,52,.10);
      --radius:18px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{max-width:520px;margin:0 auto;padding:18px 16px 120px;}

    /* Header */
    .hrow{display:flex;align-items:center;gap:10px;margin-top:8px;}
    .hicon{width:42px;height:42px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);box-shadow:0 4px 14px rgba(42,45,52,.06);}
    h1{margin:0;font-size:30px;font-weight:900;letter-spacing:-0.02em;}
    .sub{margin:8px 0 0;color:var(--muted);}

    /* Stats */
    .stats{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#FFFFFF;
      box-shadow:0 2px 10px rgba(42,45,52,.06);
      font-weight:700;
      font-size:13px;
    }

    /* List */
    .list{margin-top:16px;display:flex;flex-direction:column;gap:12px;}

    .card{
      display:flex;gap:12px;align-items:flex-start;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      box-shadow:0 8px 24px rgba(42,45,52,.08);
      cursor:pointer;
      user-select:none;
    }
    .card:active{transform:translateY(1px);}

    .check{width:22px;height:22px;margin-top:4px;accent-color:var(--accent2);}

    .meta{flex:1;min-width:0;}
    .title{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}

    .tag{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#F8FAFC;
      color:var(--text);
      font-size:13px;
      font-weight:700;
    }
    .tag.ok{background:#EAF6EF;border-color:#CFE6D7;color:var(--accent2);}
    .tag.due{background:#FFF3E0;border-color:#F6D7A8;color:var(--warn);}
    .tag.overdue{background:#FDECEC;border-color:#F4C7C7;color:var(--danger);}
    .tag.unknown{background:#F3F4F6;border-color:#E5E7EB;color:#6B7280;}

    .small{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.35;}

    .banner{
      margin-top:12px;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:#FFFFFF;
      color:var(--muted);
      box-shadow:0 6px 18px rgba(42,45,52,.06);
    }

    .error{
      margin-top:12px;
      padding:12px 14px;
      border-radius:var(--radius);
      border:1px solid #F4C7C7;
      background:#FDECEC;
      color:var(--danger);
      white-space:pre-wrap;
    }

    /* Bottom bar */
    .btnbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px 16px 18px;
      background:linear-gradient(to top, var(--bg) 70%, rgba(246,251,253,0));
    }

    .bar{
      width:min(520px, calc(100vw - 32px));
      margin:0 auto;
    }

    .barlinks{
      display:flex;justify-content:space-between;gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .linkbtn{
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      padding:0;
      text-decoration:underline;
      cursor:pointer;
    }
    .linkbtn:disabled{opacity:.55;cursor:default;}

    .btn{
      width:100%;
      display:block;
      border:none;
      border-radius:16px;
      padding:16px 18px;
      font-weight:900;
      font-size:16px;
      color:#0A1B22;
      background:var(--accent);
      box-shadow:0 10px 25px rgba(48,197,255,.25);
      cursor:pointer;
    }
    .btn:disabled{opacity:.55;box-shadow:none;cursor:default;}

    .skeleton{
      height:74px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:linear-gradient(90deg, #FFFFFF, #F2F7FA, #FFFFFF);
      background-size:200% 100%;
      animation:shimmer 1.2s linear infinite;
    }

    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}



    /* Clickable pills as filters */
    button.pill{cursor:pointer;font-family:inherit;color:inherit}
    button.pill{border:1px solid var(--border);background:#FFFFFF}
    button.pill:disabled{opacity:.55;cursor:default}
    .pill.active{border-color:#8FD5A8;box-shadow:0 10px 25px rgba(92,148,110,.18)}

    /* Toast */
    .toast{
      position:fixed;
      left:16px;
      right:16px;
      bottom:110px;
      max-width:520px;
      margin:0 auto;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#FFFFFF;
      color:var(--text);
      box-shadow:0 12px 28px rgba(42,45,52,.14);
      font-weight:800;
      z-index:50;
    }

    /* Better tap targets in Telegram */
    button, input { -webkit-tap-highlight-color: transparent; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="hrow">
      <div class="hicon">üìÖ</div>
      <h1>–°–µ–≥–æ–¥–Ω—è</h1>
    </div>
    <p class="sub" id="subtitle">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>

    <div class="stats" id="stats" style="display:none"></div>

    <div class="list" id="list">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

    <div class="banner">
      ‚ÑπÔ∏è–°–æ–≤–µ—Ç –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏ (–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ —á–∞—Ç-–±–æ—Ç–∞).
    </div>

    <div class="error" id="error" style="display:none"></div>

    <div class="toast" id="toast" style="display:none"></div>
  </div>

  <div class="btnbar">
    <div class="bar">
      <div class="barlinks">
        <button class="linkbtn" id="btnSelectAll" disabled>–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
        <button class="linkbtn" id="btnSelectNeed" disabled>–í—ã–±—Ä–∞—Ç—å: –ø–æ—Ä–∞ + –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</button>
        <button class="linkbtn" id="btnClear" disabled>–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <button class="btn" id="btnWater" disabled>‚úÖ–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤</button>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    tg.ready();
    try { tg.expand(); } catch(e){}
    try { tg.setHeaderColor('#A0DDE6'); } catch(e){}
    try { tg.setBackgroundColor('#F6FBFD'); } catch(e){}
  }

  const initData = tg ? (tg.initData || "") : "";

  const els = {
    subtitle: document.getElementById("subtitle"),
    stats: document.getElementById("stats"),
    list: document.getElementById("list"),
    error: document.getElementById("error"),
    toast: document.getElementById("toast"),
    btnWater: document.getElementById("btnWater"),
    btnSelectAll: document.getElementById("btnSelectAll"),
    btnSelectNeed: document.getElementById("btnSelectNeed"),
    btnClear: document.getElementById("btnClear"),
  };

  const state = {
    items: [],
    selected: new Set(),
    loading: true,
    saving: false,
    filter: "all",
  };

  function showError(msg){
    els.error.style.display = "block";
    els.error.textContent = msg;
  }

  function clearError(){
    els.error.style.display = "none";
    els.error.textContent = "";
  }
  function showToast(msg){
    if (!els.toast) return;
    els.toast.style.display = "block";
    els.toast.textContent = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      els.toast.style.display = "none";
      els.toast.textContent = "";
    }, 2200);
  }

  function filterLabel(f){
    if (f === "overdue") return "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ";
    if (f === "due") return "–ü–æ—Ä–∞";
    if (f === "ok") return "–û–∫";
    if (f === "unknown") return "–ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å";
    return "–í—Å–µ";
  }

  function getFilteredItems(){
    const f = state.filter || "all";
    if (f === "all") return state.items;
    return state.items.filter(x => (x.status || "ok") === f);
  }


  function apiFetch(path, opts){
    opts = opts || {};
    opts.headers = Object.assign({}, opts.headers || {}, {
      "X-Telegram-InitData": initData,
      "Content-Type": "application/json",
    });
    return fetch(path, opts);
  }

  function statusTag(s){
    // expected: overdue / due / ok / unknown
    if (s === "overdue") return {cls:"overdue", label:"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"};
    if (s === "due") return {cls:"due", label:"–ü–æ—Ä–∞"};
    if (s === "unknown") return {cls:"unknown", label:"–ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å"};
    return {cls:"ok", label:"–û–∫"};
  }

  function fmtDays(n){
    const abs = Math.abs(n);
    const d = abs % 10;
    const dd = abs % 100;
    if (dd >= 11 && dd <= 14) return abs + "–¥–Ω.";
    if (d === 1) return abs + "–¥–Ω.";
    if (d >= 2 && d <= 4) return abs + "–¥–Ω.";
    return abs + "–¥–Ω.";
  }

  function selectionCount(){
    return state.selected.size;
  }

  function updateButtons(){
    const hasItems = !state.loading && state.items.length > 0;
    const sel = selectionCount();

    els.btnWater.disabled = state.loading || state.saving || sel === 0;
    els.btnSelectAll.disabled = state.loading || state.saving || !hasItems;
    els.btnSelectNeed.disabled = state.loading || state.saving || !hasItems;
    els.btnClear.disabled = state.loading || state.saving || sel === 0;

    els.btnWater.textContent = state.saving ? "–û—Ç–º–µ—á–∞—é‚Ä¶" : "‚úÖ–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤";
  }

  els.stats.addEventListener("click", (e)=>{
    const btn = e.target && e.target.closest ? e.target.closest("[data-filter]") : null;
    if (!btn || state.loading || state.saving) return;
    const f = btn.getAttribute("data-filter") || "all";
    state.filter = f;
    // when filter changes, keep selection but update counters/text
    render();
  });

  function render(){
    // subtitle
    if (state.loading){
      els.subtitle.textContent = "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
    } else {
      const total = state.items.length;
      const sel = selectionCount();
      els.subtitle.textContent = total
        ? `–†–∞—Å—Ç–µ–Ω–∏–π: ${total} ¬∑ –í—ã–±—Ä–∞–Ω–æ: ${sel} ¬∑ –§–∏–ª—å—Ç—Ä: ${filterLabel(state.filter)}`
        : "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π. –î–æ–±–∞–≤—å –∏—Ö –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ /add_plant";
    }

    // stats
    if (!state.loading && state.items.length){
      const counts = {overdue:0, due:0, ok:0, unknown:0};
      for (const it of state.items){
        const k = it.status || "ok";
        counts[k] = (counts[k] || 0) + 1;
      }
      const totalAll = (counts.overdue||0) + (counts.due||0) + (counts.ok||0) + (counts.unknown||0);
      els.stats.innerHTML = `
        <button type="button" class="pill ${state.filter==='all'?'active':''}" data-filter="all">üìã–í—Å–µ: ${totalAll}</button>
        <button type="button" class="pill ${state.filter==='overdue'?'active':''}" data-filter="overdue">ü•≤–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ${counts.overdue||0}</button>
        <button type="button" class="pill ${state.filter==='due'?'active':''}" data-filter="due">‚è∞–ü–æ—Ä–∞: ${counts.due||0}</button>
        <button type="button" class="pill ${state.filter==='ok'?'active':''}" data-filter="ok">‚úÖ–û–∫: ${counts.ok||0}</button>
        <button type="button" class="pill ${state.filter==='unknown'?'active':''}" data-filter="unknown">‚ÑπÔ∏è–ù–∞—Å—Ç—Ä–æ–∏—Ç—å: ${counts.unknown||0}</button>
      `;
      els.stats.style.display = "flex";
    } else {
      els.stats.style.display = "none";
    }

    // list
    els.list.innerHTML = "";
    if (state.loading){
      for (let i=0;i<3;i++){
        const sk = document.createElement("div");
        sk.className = "skeleton";
        els.list.appendChild(sk);
      }
    } else if (!state.items.length){
      const empty = document.createElement("div");
      empty.className = "banner";
      empty.textContent = "–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ /add_plant.";
      els.list.appendChild(empty);
    } else {
      const filtered = getFilteredItems();

      if (!filtered.length){
        const empty = document.createElement("div");
        empty.className = "banner";
        empty.textContent = "–ü–æ —Ñ–∏–ª—å—Ç—Ä—É –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.";
        els.list.appendChild(empty);
        updateButtons();
        return;
      }

      for (const it of filtered){
        const card = document.createElement("div");
        card.className = "card";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "check";
        cb.checked = state.selected.has(it.id);

        cb.addEventListener("change", ()=>{
          if (cb.checked) state.selected.add(it.id);
          else state.selected.delete(it.id);
          updateButtons();
          // refresh subtitle only
          if (!state.loading) {
            const total = state.items.length;
            const sel = selectionCount();
            els.subtitle.textContent = total ? `–†–∞—Å—Ç–µ–Ω–∏–π: ${total} ¬∑ –í—ã–±—Ä–∞–Ω–æ: ${sel} ¬∑ –§–∏–ª—å—Ç—Ä: ${filterLabel(state.filter)}` : els.subtitle.textContent;
          }
        });

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = it.name;

        const row = document.createElement("div");
        row.className = "row";
        const tag = statusTag(it.status);

        const st = document.createElement("span");
        st.className = `tag ${tag.cls}`;
        st.textContent = tag.label;

        const n = document.createElement("span");
        n.className = "tag";
        n.textContent = it.norm_days ? `–ù–æ—Ä–º–∞: ${it.norm_days}–¥–Ω` : "–ù–æ—Ä–º–∞: ‚Äî ";

        row.appendChild(st);
        row.appendChild(n);

        const small = document.createElement("div");
        small.className = "small";
        const parts = [];
        if (it.days_since_last_watering !== null && it.days_since_last_watering !== undefined){
          parts.push(`–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${fmtDays(it.days_since_last_watering)} –Ω–∞–∑–∞–¥`);
        } else {
          parts.push("–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ‚Äî ");
        }
        if (it.due_in_days !== null && it.due_in_days !== undefined){
          if (it.due_in_days < 0) parts.push(`–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${fmtDays(it.due_in_days)}`);
          else if (it.due_in_days === 0) parts.push("–ü–æ—Ä–∞ —Å–µ–≥–æ–¥–Ω—è");
          else parts.push(`–î–æ –ø–æ–ª–∏–≤–∞: ${fmtDays(it.due_in_days)}`);
        }
        small.textContent = parts.join(" ¬∑ ");

        meta.appendChild(t);
        meta.appendChild(row);
        meta.appendChild(small);

        card.appendChild(cb);
        card.appendChild(meta);

        // tap anywhere toggles checkbox
        card.addEventListener("click", (e)=>{
          if (e.target === cb) return;
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event("change"));
        });

        els.list.appendChild(card);
      }
    }

    updateButtons();
  }

  async function load(){
    state.loading = true;
    state.saving = false;
    clearError();
    render();

    if (!initData){
      state.loading = false;
      render();
      showError("–ü–æ—Ö–æ–∂–µ, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ –∏–∑ Telegram.\n–û—Ç–∫—Ä–æ–π Mini App –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º PlantBuddy.");
      return;
    }

    try{
      const r = await apiFetch("/api/today", { method: "GET" });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok){
        throw new Error(JSON.stringify(j));
      }

      state.items = (j.items || []).map(x => ({
        id: x.id,
        name: x.name,
        status: x.status || "ok",
        norm_days: x.norm_days ?? null,
        days_since_last_watering: x.days_since_last_watering ?? null,
        due_in_days: x.due_in_days ?? null,
      }));

      // Sort: overdue -> due -> unknown -> ok
      const order = {overdue:0, due:1, unknown:2, ok:3};
      state.items.sort((a,b)=> (order[a.status] ?? 9) - (order[b.status] ?? 9));

      state.loading = false;
      render();
    } catch(e){
      state.loading = false;
      render();
      showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + String(e && e.message ? e.message : e));
    }
  }

  function selectAll(){
    state.selected = new Set(state.items.map(x => x.id));
    render();
  }

  function selectNeed(){
    const need = state.items.filter(x => x.status === "due" || x.status === "overdue");
    state.selected = new Set(need.map(x => x.id));
    render();
  }

  function clearSelection(){
    state.selected.clear();
    render();
  }

  els.btnSelectAll.addEventListener("click", ()=>{
    if (state.loading || state.saving) return;
    selectAll();
  });

  els.btnSelectNeed.addEventListener("click", ()=>{
    if (state.loading || state.saving) return;
    selectNeed();
  });

  els.btnClear.addEventListener("click", ()=>{
    if (state.loading || state.saving) return;
    clearSelection();
  });

  els.btnWater.addEventListener("click", async ()=>{
    if (selectionCount() === 0 || state.loading || state.saving) return;

    state.saving = true;
    clearError();
    updateButtons();

    try{
      const body = { plant_ids: Array.from(state.selected) };
      const r = await apiFetch("/api/water", { method: "POST", body: JSON.stringify(body) });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok){
        throw new Error(JSON.stringify(j));
      }
      const updated = (j && typeof j.updated === "number") ? j.updated : body.plant_ids.length;
      showToast(`‚úÖ–ü–æ–ª–∏–≤ –æ—Ç–º–µ—á–µ–Ω: ${updated}`);
      state.selected.clear();
      await load();
    } catch(e){
      state.saving = false;
      updateButtons();
      showError("–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏: " + String(e && e.message ? e.message : e));
    }
  });

  load();
})();
</script>
</body>
</html>

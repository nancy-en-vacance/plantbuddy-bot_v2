<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PlantBuddy</title>
  <style>

  :root{
    --bg:#F6FBFD;
    --card:#FFFFFF;
    --text:#2A2D34;
    --muted:#4B5563;
    --border:#D7E2E8;
    --accent:#30C5FF;
    --accent2:#5C946E;
    --accent3:#80C2AF;
    --danger:#D64545;
    --warn:#C57F1E;
    --shadow:0 10px 30px rgba(42,45,52,.10);
    --radius:18px;
  }

  html,body{height:100%;}
  body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  .wrap{max-width:520px;margin:0 auto;padding:18px 16px 100px;}

  .header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-top:10px;}
  .h1{font-size:40px;font-weight:800;letter-spacing:-0.02em;display:flex;align-items:center;gap:10px;}
  .sub{margin-top:6px;color:var(--muted);}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border:1px solid var(--border);
    border-radius:999px;background:#FFFFFF;
    box-shadow:0 2px 10px rgba(42,45,52,.06);
  }

  .list{margin-top:18px;display:flex;flex-direction:column;gap:12px;}

  .card{
    display:flex;gap:12px;align-items:flex-start;
    padding:14px 14px;
    border:1px solid var(--border);
    border-radius:var(--radius);
    background:var(--card);
    box-shadow:0 8px 24px rgba(42,45,52,.08);
  }

  .check{width:22px;height:22px;margin-top:4px;accent-color:var(--accent2);}

  .meta{flex:1;min-width:0;}
  .title{font-weight:750;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}

  .tag{
    display:inline-flex;align-items:center;justify-content:center;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#F8FAFC;
    color:var(--text);
    font-size:13px;
  }

  .tag.ok{background:#EAF6EF;border-color:#CFE6D7;color:var(--accent2);}
  .tag.due{background:#FFF3E0;border-color:#F6D7A8;color:var(--warn);}
  .tag.overdue{background:#FDECEC;border-color:#F4C7C7;color:var(--danger);}
  .tag.unknown{background:#F3F4F6;border-color:#E5E7EB;color:#6B7280;}

  .small{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.35;}

  .banner{
    padding:14px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:#FFFFFF;
    color:var(--muted);
  }

  .error{
    margin-top:14px;
    padding:12px 14px;
    border-radius:var(--radius);
    border:1px solid #F4C7C7;
    background:#FDECEC;
    color:var(--danger);
    white-space:pre-wrap;
  }

  .btnbar{
    position:fixed;left:0;right:0;bottom:0;
    padding:14px 16px 18px;
    background:linear-gradient(to top, var(--bg) 70%, rgba(246,251,253,0));
  }

  .btn{
    width:min(520px, calc(100vw - 32px));
    margin:0 auto;
    display:block;
    border:none;
    border-radius:16px;
    padding:16px 18px;
    font-weight:800;
    font-size:16px;
    color:#0A1B22;
    background:var(--accent);
    box-shadow:0 10px 25px rgba(48,197,255,.25);
  }
  .btn:disabled{opacity:.55;box-shadow:none;}

  .skeleton{
    height:74px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    background:linear-gradient(90deg, #FFFFFF, #F2F7FA, #FFFFFF);
    background-size:200% 100%;
    animation:shimmer 1.2s linear infinite;
  }

  @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="hrow">
      <div class="hicon">üìÖ</div>
      <h1>–°–µ–≥–æ–¥–Ω—è</h1>
    </div>
    <p class="sub" id="subtitle">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>

    <div class="stats" id="stats" style="display:none"></div>

    <div class="list" id="list">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

    <div class="banner">
      ‚ÑπÔ∏è–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ OpenAI(—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –Ω–∞–∂–º—ë—à—å –∞–Ω–∞–ª–∏–∑ –≤ –±–æ—Ç–µ).
      <div class="err" id="error" style="display:none"></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnWater" disabled>‚úÖ–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤</button>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    tg.ready();
    try { tg.expand(); } catch(e){}
    // Light theme + brand accents (safe to ignore if not supported)
    try { tg.setHeaderColor('#A0DDE6'); } catch(e){}
    try { tg.setBackgroundColor('#F6FBFD'); } catch(e){}
  }

  const initData = tg ? (tg.initData || "") : "";
  const els = {
    subtitle: document.getElementById("subtitle"),
    stats: document.getElementById("stats"),
    list: document.getElementById("list"),
    error: document.getElementById("error"),
    btnWater: document.getElementById("btnWater"),
  };

  const state = {
    items: [],
    selected: new Set(),
    loading: true,
  };

  function showError(msg){
    els.error.style.display = "block";
    els.error.textContent = msg;
  }

  function apiFetch(path, opts){
    opts = opts || {};
    opts.headers = Object.assign({}, opts.headers || {}, {
      "X-Telegram-InitData": initData,
      "Content-Type": "application/json",
    });
    return fetch(path, opts);
  }

  function statusTag(s){
    // expected: overdue / due / ok / unknown
    if (s === "overdue") return {cls:"danger", label:"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"};
    if (s === "due") return {cls:"warn", label:"–ü–æ—Ä–∞"};
    if (s === "unknown") return {cls:"neutral", label:"–ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å"};
    return {cls:"ok", label:"–û–∫"};
  }

  function render(){
    // subtitle
    if (state.loading){
      els.subtitle.textContent = "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
    } else {
      const total = state.items.length;
      const sel = state.selected.size;
      els.subtitle.textContent = total ? `–†–∞—Å—Ç–µ–Ω–∏–π: ${total} ¬∑ –í—ã–±—Ä–∞–Ω–æ: ${sel}` : "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π. –î–æ–±–∞–≤—å –∏—Ö –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ /add_plant";
    }

    // stats
    if (!state.loading && state.items.length){
      const counts = {overdue:0, due:0, ok:0, unknown:0};
      for (const it of state.items){ counts[it.status] = (counts[it.status]||0) + 1; }
      els.stats.innerHTML = `
        <div class="pill">üß°–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ${counts.overdue||0}</div>
        <div class="pill">‚è∞–ü–æ—Ä–∞: ${counts.due||0}</div>
        <div class="pill">‚úÖ–û–∫: ${counts.ok||0}</div>
        <div class="pill">‚ÑπÔ∏è–ù–∞—Å—Ç—Ä–æ–∏—Ç—å: ${counts.unknown||0}</div>
      `;
      els.stats.style.display = "flex";
    } else {
      els.stats.style.display = "none";
    }

    // list
    els.list.innerHTML = "";
    if (state.loading){
      for (let i=0;i<3;i++){
        const sk = document.createElement("div");
        sk.className = "skeleton";
        els.list.appendChild(sk);
      }
    } else if (!state.items.length){
      // empty
      const empty = document.createElement("div");
      empty.className = "banner";
      empty.textContent = "–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ /add_plant.";
      els.list.appendChild(empty);
    } else {
      for (const it of state.items){
        const card = document.createElement("div");
        card.className = "card";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "check";
        cb.checked = state.selected.has(it.id);
        cb.addEventListener("change", ()=>{
          if (cb.checked) state.selected.add(it.id);
          else state.selected.delete(it.id);
          render();
        });

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = it.name;

        const row = document.createElement("div");
        row.className = "row";
        const tag = statusTag(it.status);
        const st = document.createElement("span");
        st.className = `tag ${tag.cls}`;
        st.textContent = tag.label;

        const n = document.createElement("span");
        n.className = "tag";
        n.textContent = it.norm_days ? `–ù–æ—Ä–º–∞: ${it.norm_days}–¥–Ω` : "–ù–æ—Ä–º–∞: ‚Äî";

        row.appendChild(st);
        row.appendChild(n);

        const small = document.createElement("div");
        small.className = "small";
        const parts = [];
        if (it.days_since_last_watering !== null && it.days_since_last_watering !== undefined){
          parts.push(`–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${it.days_since_last_watering}–¥–Ω –Ω–∞–∑–∞–¥`);
        } else {
          parts.push("–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ‚Äî");
        }
        if (it.due_in_days !== null && it.due_in_days !== undefined){
          if (it.due_in_days < 0) parts.push(`–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${Math.abs(it.due_in_days)}–¥–Ω`);
          else if (it.due_in_days === 0) parts.push("–ü–æ—Ä–∞ —Å–µ–≥–æ–¥–Ω—è");
          else parts.push(`–î–æ –ø–æ–ª–∏–≤–∞: ${it.due_in_days}–¥–Ω`);
        }
        small.textContent = parts.join(" ¬∑ ");

        meta.appendChild(t);
        meta.appendChild(row);
        meta.appendChild(small);

        card.appendChild(cb);
        card.appendChild(meta);

        // tap anywhere toggles checkbox
        card.addEventListener("click", (e)=>{
          if (e.target === cb) return;
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event("change"));
        });

        els.list.appendChild(card);
      }
    }

    // button
    els.btnWater.disabled = state.selected.size === 0 || state.loading;
  }

  async function load(){
    state.loading = true;
    render();

    if (!initData){
      state.loading = false;
      render();
      showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {"detail":"Missing initData"}');
      return;
    }

    try{
      const r = await apiFetch("/api/today", { method: "GET" });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok){
        throw new Error(JSON.stringify(j));
      }

      // Expect backend to return: { items: [...] }
      state.items = (j.items || []).map(x => ({
        id: x.id,
        name: x.name,
        status: x.status || "ok",
        norm_days: x.norm_days ?? null,
        days_since_last_watering: x.days_since_last_watering ?? null,
        due_in_days: x.due_in_days ?? null,
      }));

      // Sort: overdue -> due -> unknown -> ok
      const order = {overdue:0, due:1, unknown:2, ok:3};
      state.items.sort((a,b)=> (order[a.status]??9) - (order[b.status]??9));

      state.loading = false;
      render();
    } catch(e){
      state.loading = false;
      render();
      showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + String(e && e.message ? e.message : e));
    }
  }

  els.btnWater.addEventListener("click", async ()=>{
    if (state.selected.size === 0) return;
    els.btnWater.disabled = true;
    els.btnWater.textContent = "–û—Ç–º–µ—á–∞—é‚Ä¶";

    try{
      const body = { plant_ids: Array.from(state.selected) };
      const r = await apiFetch("/api/water", { method: "POST", body: JSON.stringify(body) });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok){
        throw new Error(JSON.stringify(j));
      }
      state.selected.clear();
      await load();
      els.btnWater.textContent = "‚úÖ–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤";
    } catch(e){
      showError("–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏: " + String(e && e.message ? e.message : e));
      els.btnWater.textContent = "‚úÖ–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤";
      els.btnWater.disabled = false;
    }
  });

  load();
})();
</script>
</body>
</html>

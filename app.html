<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PlantBuddy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700&display=swap" rel="stylesheet">
  <style>

    :root{
      --bg:#f9fff7;
      --card:#FFFFFF;
      --text:#2A2D34;
      --muted:#4B5563;
      --border:#D7E2E8;
      --accent:#30C5FF;
      --accent2:#5C946E;
      --danger:#D64545;
      --warn:#C57F1E;
      --shadow:0 10px 30px rgba(42,45,52,.10);
      --radius:18px;
      --brand:#7ed957;
      --brandText:#545454;
      --tabAccent:#0097b2;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{max-width:520px;margin:0 auto;padding:18px 16px 120px;}

    /* Top brand */
.topbar{margin-top:8px;}
.brand{display:flex;align-items:flex-start;gap:10px;justify-content:flex-start;}
.brand-emoji{font-size:42px;line-height:1;}
.brand-text{display:flex;flex-direction:column;gap:2px;}
.brand-title{font-family:"Fredoka", system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Arial, sans-serif;font-weight:700;font-size:28px;letter-spacing:-0.02em;color:var(--brand);line-height:1.05;}
.brand-sub{color:var(--brandText);font-size:14px;line-height:1.15;}

/* Tabs */
.tabs{display:flex;gap:10px;margin:14px 0 10px;flex-wrap:wrap}
.tab{border:1px solid var(--border);background:var(--card);color:var(--muted);padding:10px 12px;border-radius:999px;font-weight:800; box-shadow:0 4px 14px rgba(42,45,52,.06); cursor:pointer}
.tab.active{color:var(--tabAccent);border-color:rgba(0,151,178,.55); box-shadow:0 10px 22px rgba(0,151,178,.14)}
.screen{display:none}
.screen.active{display:block}

/* Stats */
    .stats{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#FFFFFF;
      box-shadow:0 2px 10px rgba(42,45,52,.06);
      font-weight:700;
      font-size:13px;
    }

    /* List */
    .list{margin-top:16px;display:flex;flex-direction:column;gap:12px;}

    .card{
      display:flex;gap:12px;align-items:flex-start;
      padding:14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      box-shadow:0 8px 24px rgba(42,45,52,.08);
      cursor:pointer;
      user-select:none;
    }
    .card:active{transform:translateY(1px);}

    .check{width:22px;height:22px;margin-top:4px;accent-color:var(--accent2);}

    .meta{flex:1;min-width:0;}
    .title{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}

    .tag{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#F8FAFC;
      color:var(--text);
      font-size:13px;
      font-weight:700;
    }
    .tag.ok{background:#EAF6EF;border-color:#CFE6D7;color:var(--accent2);}
    .tag.due{background:#FFF3E0;border-color:#F6D7A8;color:var(--warn);}
    .tag.overdue{background:#FDECEC;border-color:#F4C7C7;color:var(--danger);}
    .tag.unknown{background:#F3F4F6;border-color:#E5E7EB;color:#6B7280;}

    .small{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.35;}

    .banner{
      margin-top:12px;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:#FFFFFF;
      color:var(--muted);
      box-shadow:0 6px 18px rgba(42,45,52,.06);
    }

    .error{
      margin-top:12px;
      padding:12px 14px;
      border-radius:var(--radius);
      border:1px solid #F4C7C7;
      background:#FDECEC;
      color:var(--danger);
      white-space:pre-wrap;
    }

    /* Bottom bar */
    .btnbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px 16px 18px;
      background:linear-gradient(to top, var(--bg) 70%, rgba(246,251,253,0));
    }

    .bar{
      width:min(520px, calc(100vw - 32px));
      margin:0 auto;
    }

    .barlinks{
      display:flex;justify-content:space-between;gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .linkbtn{
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      padding:0;
      text-decoration:underline;
      cursor:pointer;
    }
    .linkbtn:disabled{opacity:.55;cursor:default;}

    .btn{
      width:100%;
      display:block;
      border:none;
      border-radius:16px;
      padding:16px 18px;
      font-weight:900;
      font-size:16px;
      color:#0A1B22;
      background:var(--accent);
      box-shadow:0 10px 25px rgba(48,197,255,.25);
      cursor:pointer;
    }

    .btn.inactive{
      background:#E5E7EB;
      color:#6B7280;
      box-shadow:none;
      cursor:default;
    }
    .btn:disabled{opacity:.55;box-shadow:none;cursor:default;}

    .empty{margin:28px 0;padding:26px 18px;border-radius:var(--radius);border:1px dashed rgba(125,217,87,.45);background:rgba(125,217,87,.06);color:var(--brandText);font-weight:900;text-align:center;}

    .skeleton{
      height:74px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:linear-gradient(90deg, #FFFFFF, #F2F7FA, #FFFFFF);
      background-size:200% 100%;
      animation:shimmer 1.2s linear infinite;
    }

    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

    /* Better tap targets in Telegram */
    button, input { -webkit-tap-highlight-color: transparent; }
  

    /* --- Tabs / Screens --- */
    .tabs{display:flex;gap:10px;margin:12px 0 10px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:var(--card);color:var(--muted);padding:10px 12px;border-radius:999px;
      font-weight:700; box-shadow:0 4px 14px rgba(42,45,52,.06); cursor:pointer}
    .tab.active{color:var(--tabAccent);border-color:rgba(0,151,178,.55); box-shadow:0 10px 22px rgba(0,151,178,.14)}
    .screen{display:none}
    .screen.active{display:block}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn2{border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 12px;border-radius:14px;font-weight:700;cursor:pointer}
    .btn2:disabled{opacity:.6;cursor:default}
    .btn2.danger{border-color:rgba(214,69,69,.35); color:var(--danger)}
    .btn2.accent{border-color:rgba(48,197,255,.55)}
    .mini{font-size:12px;color:var(--muted)}
    .inputrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);padding:10px 12px;border-radius:999px;font-weight:700;cursor:pointer}
    
    .pill.passive{opacity:.75;cursor:default;pointer-events:none}
.pill.active{border-color:rgba(48,197,255,.55)}
    .toast{position:fixed;left:50%;bottom:86px;transform:translateX(-50%);background:#0f172a;color:#fff;
      padding:10px 12px;border-radius:999px;font-weight:700;box-shadow:0 14px 34px rgba(0,0,0,.25); display:none; z-index:50}

  
    /* Bottom sheet (Plants actions) */
    .overlay{
      position:fixed; inset:0;
      background:rgba(17,24,39,.35);
      backdrop-filter: blur(2px);
      display:none;
      z-index:50;
    }
    .overlay.show{display:block;}

    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      z-index:60;
      display:none;
      padding:12px 16px calc(16px + env(safe-area-inset-bottom));
    }
    .sheet.show{display:block;}

    .sheetcard{
      width:min(520px, calc(100vw - 32px));
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(42,45,52,.22);
      overflow:hidden;
      transform: translateY(8px);
      animation: sheetIn .18s ease-out forwards;
    }
    @keyframes sheetIn { to { transform: translateY(0); } }

    .sheethead{padding:14px 14px 10px; border-bottom:1px solid rgba(215,226,232,.7);}
    .sheettitle{font-weight:900;font-size:16px;line-height:1.15;color:var(--brand);}
    .sheetmeta{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.3;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .sheetmeta .dot{opacity:.6}

    .sheetactions{padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
    .actionbtn{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-size:14px;
      display:flex;align-items:center;justify-content:center;gap:8px;
      cursor:pointer;
    }
    .actionbtn:active{transform:translateY(1px);}
    .actionbtn.danger{border-color:#F4C7C7;background:#FDECEC;color:var(--danger);}
    .actionbtn.accent{border-color:#BFE9F7;background:#E9F8FE;}
    .actionbtn.neutral{background:#F8FAFC;}
    .actionbtn.ghost{background:transparent;color:var(--muted);}

    .chev{margin-left:auto;color:#9CA3AF;font-weight:900;}

  
    #tabNorms{display:none!important;}
    #screenNorms{display:none!important;}

  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="brand-emoji" aria-hidden="true">üå±</div>
        <div class="brand-text">
          <div class="brand-title">PlantBuddy</div>
          <div class="brand-sub">–ó–Ω–∞—é, –∫–æ–≥–¥–∞ –ø–æ–ª–∏–≤–∞—Ç—å —Ç–≤–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</div>
        </div>
      </div>
    </header>

<div class="tabs" role="tablist">
      <button class="tab active" id="tabToday">üìÖ–°–µ–≥–æ–¥–Ω—è</button>
      <button class="tab" id="tabPlants">ü™¥–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</button>
      <button class="tab" id="tabNorms">üí¶–ù–æ—Ä–º—ã</button>
    </div>

    <!-- SCREEN: TODAY -->
    <section class="screen active" id="screenToday">
      <div class="list" id="list">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <div class="error" id="error" style="display:none"></div>
    </section>

    <!-- SCREEN: PLANTS -->
    <section class="screen" id="screenPlants">
      <div class="row" style="margin:2px 0 10px;">
        <div class="inputrow">
          <button class="pill active" id="plantsActive">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
          <button class="pill" id="plantsArchived">–ê—Ä—Ö–∏–≤</button>
        </div>
        <button class="btn2 accent" id="btnAddPlant">‚ûï–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div class="list" id="plantsList">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <div class="error" id="plantsError" style="display:none"></div>
    </section>

    <!-- SCREEN: NORMS -->
    <section class="screen" id="screenNorms">
      <div class="row" style="margin:2px 0 10px;">
        <div class="mini">–ù–æ—Ä–º–∞ = —Ä–∞–∑ –≤ N –¥–Ω–µ–π (–¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π)</div>
        <button class="btn2" id="btnRefreshNorms">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="list" id="normsList">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <div class="error" id="normsError" style="display:none"></div>
    </section>
  </div>

  <div class="btnbar" id="btnbar">
    <div class="bar">
      <button class="btn" id="btnWater" disabled>üí¶–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª–∏–≤</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetcard" role="dialog" aria-modal="true">
      <div class="sheethead">
        <div class="sheettitle" id="sheetTitle">–†–∞—Å—Ç–µ–Ω–∏–µ</div>
        <div class="sheetmeta" id="sheetMeta"></div>
      </div>
      <div class="sheetactions" id="sheetActions"></div>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    tg.ready();
    try { tg.expand(); } catch(e){}
    try { tg.setHeaderColor('#A0DDE6'); } catch(e){}
    try { tg.setBackgroundColor('#f9fff7'); } catch(e){}
  }

  const initData = tg ? (tg.initData || "") : "";

  const els = {
    // header
    toast: document.getElementById("toast"),

    // sheet
    overlay: document.getElementById("overlay"),
    sheet: document.getElementById("sheet"),
    sheetTitle: document.getElementById("sheetTitle"),
    sheetMeta: document.getElementById("sheetMeta"),
    sheetActions: document.getElementById("sheetActions"),

    // tabs
    tabToday: document.getElementById("tabToday"),
    tabPlants: document.getElementById("tabPlants"),
    tabNorms: document.getElementById("tabNorms"),

    // screens
    screenToday: document.getElementById("screenToday"),
    screenPlants: document.getElementById("screenPlants"),
    screenNorms: document.getElementById("screenNorms"),

    // today    list: document.getElementById("list"),
    error: document.getElementById("error"),    btnWater: document.getElementById("btnWater"),    btnbar: document.getElementById("btnbar"),

    // plants
    plantsActive: document.getElementById("plantsActive"),
    plantsArchived: document.getElementById("plantsArchived"),
    plantsList: document.getElementById("plantsList"),
    plantsError: document.getElementById("plantsError"),
    btnAddPlant: document.getElementById("btnAddPlant"),

    // norms
    normsList: document.getElementById("normsList"),
    normsError: document.getElementById("normsError"),
    btnRefreshNorms: document.getElementById("btnRefreshNorms"),
  };

    // Feature flags
    

const state = {
    screen: "today", // today|plants|norms
    // today
    items: [],
    selected: new Set(),
    loading: true,
    saving: false,
    filter: "all", // all|overdue|due|ok|unknown
    // plants
    plants: [],
    plantsMode: "active", // active|archived
    plantsLoading: false,
    // norms
    norms: [],
    normsLoading: false,
    sheetPlantId: null,
  };

  function toast(msg){
    if (!msg) return;
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ els.toast.style.display = "none"; }, 1800);
  }

  function showError(el, msg){
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearError(el){
    el.style.display = "none";
    el.textContent = "";
  }

  function setScreen(screen){
    closePlantSheet();
    state.screen = screen;

    // screens
    els.screenToday?.classList.toggle("active", screen==="today");
    els.screenPlants?.classList.toggle("active", screen==="plants");
    els.screenNorms?.classList.toggle("active", screen==="norms");

    // tabs
    els.tabToday?.classList.toggle("active", screen==="today");
    els.tabPlants?.classList.toggle("active", screen==="plants");
    els.tabNorms?.classList.toggle("active", screen==="norms");

    // bottom bar only on today
    els.btnbar.style.display = screen==="today" ? "block" : "none";

    // lazy load
    if (screen==="plants" && state.plants.length===0) loadPlants();
    if (screen==="norms" && state.norms.length===0) loadNorms();
  }

  function apiFetch(path, opts){
    opts = opts || {};
    opts.headers = Object.assign({}, opts.headers || {}, {
      "Content-Type": "application/json",
      "X-Telegram-InitData": initData
    });

    // Timeout to avoid endless skeletons
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 12000);
    opts.signal = controller.signal;

    return fetch(path, opts).then(async (res)=>{
      clearTimeout(t);
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){}

      if (!res.ok){
        const msg = (data && (data.detail || data.message)) || text || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }).catch((e)=>{
      clearTimeout(t);
      if (e && e.name === "AbortError") throw new Error("–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (12s). –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      throw e;
    });
  }

  // -------- TODAY --------
  function statusCounts(items){
    const c = {overdue:0, due:0, ok:0, unknown:0, all: items.length};
    for (const it of items){
      const s = it.status || "unknown";
      if (c[s] !== undefined) c[s] += 1;
      else c.unknown += 1;
    }
    return c;
  }

  function renderToday(){
    clearError(els.error);const items = state.items.filter(it => {
      const st = (it.status || "unknown");
      if (state.filter==="all") return (st==="overdue" || st==="due" || st==="unknown");
      return st===state.filter;
    });

        if (!items.length){
      if (state.filter==="all"){
        els.list.innerHTML = `<div class="empty">ü™¥ –°–µ–≥–æ–¥–Ω—è –≤—Å–µ –æ–∫</div>`;
      } else {
        els.list.innerHTML = `<div class="empty">–°–µ–≥–æ–¥–Ω—è –≤—Å–µ –æ–∫</div>`;
      }
    } else {
      els.list.innerHTML = items.map(it=>{
        const checked = state.selected.has(it.id);
        const status = it.status || "unknown";
        const badgeText = status==="overdue" ? "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" :
                          status==="due" ? "–ü–æ—Ä–∞" :
                          status==="ok" ? (it.due_in_days!=null ? `–ß–µ—Ä–µ–∑ ${it.due_in_days} –¥–Ω–µ–π` : "–û–∫") :
                          "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å";
        const meta1 = it.days_since_last_watering==null ? "–ü–æ–ª–∏–≤: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" : `–ü–æ–ª–∏–≤: ${it.days_since_last_watering} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
        const meta2 = it.norm_days==null ? "–Ω–æ—Ä–º–∞: ‚Äî" : `–Ω–æ—Ä–º–∞: ${it.norm_days} –¥–Ω–µ–π`;
        return `
          <button class="card ${checked ? "selected" : ""}" data-id="${it.id}">
            <div class="top">
              <div class="name">${escapeHtml(it.name || "")}</div>
              <span class="badge ${status}">${badgeText}</span>
            </div>
            <div class="meta">${meta1}<span class="dot">‚Ä¢</span>${meta2}</div>
          </button>
        `;
      }).join("");
    }

    // card clicks
    els.list.querySelectorAll("[data-id]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = Number(btn.getAttribute("data-id"));
        if (!id) return;
        if (state.selected.has(id)) state.selected.delete(id);
        else state.selected.add(id);
        renderToday();
        updateButtons();
      });
    });    updateButtons();
  }

  function updateButtons(){
    const c = statusCounts(state.items);
    const action = c.overdue + c.due + c.unknown;
    const any = state.selected.size>0;
    const disabledGlobal = state.loading || state.saving || state.items.length===0;

    // main action button
    if (action === 0) {
      els.btnWater.classList.add("inactive");
      els.btnWater.disabled = false; // –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
    } else {
      els.btnWater.classList.remove("inactive");
      els.btnWater.disabled = disabledGlobal || !any;
    }
  }


  async function loadToday(){
    state.loading = true;
    state.items = [];
    state.selected = new Set();
    state.filter = "all";
    updateButtons();
    els.list.innerHTML = `<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>`;
    clearError(els.error);

    try{
      const data = await apiFetch("/api/today", {method:"GET"});
      state.items = (data && Array.isArray(data.items)) ? data.items : [];
      state.loading = false;
      renderToday();
    }catch(e){
      state.loading = false;
      const msg = (e && e.message) ? e.message : "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      showError(els.error, msg);
      els.list.innerHTML = `<div class="empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>`;
      try{ toast("‚ö†Ô∏è" + msg); }catch(_){}
    }finally{
      updateButtons();
    }
  }

  async function markWatered(){
    if (state.saving || state.selected.size===0) return;
    state.saving = true;
    updateButtons();
    clearError(els.error);
    try{
      const ids = Array.from(state.selected);
      const res = await apiFetch("/api/water", {method:"POST", body: JSON.stringify({plant_ids: ids})});
      toast(`‚úÖ–ü–æ–ª–∏–≤ –æ—Ç–º–µ—á–µ–Ω: ${res && res.updated!=null ? res.updated : ids.length}`);
      await loadToday();
    }catch(e){
      showError(els.error, e && e.message ? e.message : "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      state.saving = false;
      updateButtons();
    }finally{
      state.saving = false;
      updateButtons();
    }
  }

      
  // -------- PLANTS --------
  function renderPlants(){
    clearError(els.plantsError);

    if (state.plantsLoading){
      els.plantsList.innerHTML = `<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>`;
      return;
    }
    if (!state.plants.length){
      els.plantsList.innerHTML = `<div class="empty">${state.plantsMode==="active" ? "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π." : "–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç."}</div>`;
      return;
    }

    els.plantsList.innerHTML = state.plants.map(p=>{
      const norm = p.water_every_days==null ? "–Ω–æ—Ä–º–∞: ‚Äî" : `–Ω–æ—Ä–º–∞: ${p.water_every_days} –¥–Ω–µ–π`;
      const lw = p.last_watered_at ? `–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${formatDate(p.last_watered_at)}` : "–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ‚Äî";
      return `
        <div class="card plantcard" data-id="${p.id}">
          <div class="meta" style="flex:1;min-width:0">
            <div class="title">${escapeHtml(p.name || "")}</div>
            ${daysLeftText(p) ? `<div class="row" style="justify-content:flex-start;margin-top:10px"><span class="tag unknown" style="background:#F8FAFC">${escapeHtml(daysLeftText(p))}</span></div>` : ``}
          </div>
          <div class="chev">‚Ä∫</div>
        </div>
      `;
    }).join("");

    els.plantsList.querySelectorAll(".plantcard").forEach(card=>{
      card.addEventListener("click", ()=>{
        const id = Number(card.getAttribute("data-id"));
        if (!id) return;
        openPlantSheet(id);
      });
    });
  }

  function openPlantSheet(id){
    const p = state.plants.find(x=>x.id===id);
    if (!p) return;

    state.sheetPlantId = id;

    els.sheetTitle.textContent = p.name || "–†–∞—Å—Ç–µ–Ω–∏–µ";
    const norm = p.water_every_days==null ? "–Ω–æ—Ä–º–∞: ‚Äî" : `–Ω–æ—Ä–º–∞: ${p.water_every_days} –¥–Ω–µ–π`;
    const lw = p.last_watered_at ? `–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${formatDate(p.last_watered_at)}` : "–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ‚Äî";
    els.sheetMeta.innerHTML = `<span>${norm}</span><span class="dot">‚Ä¢</span><span>${lw}</span>`;

    const isActive = state.plantsMode==="active";
    const actions = [];

    if (isActive){
      actions.push(`<button class="actionbtn neutral" data-act="rename">‚úèÔ∏è–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>`);
      actions.push(`<button class="actionbtn" data-act="norm">üí¶–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ—Ä–º—É</button>`);
      actions.push(`<button class="actionbtn danger" data-act="archive">üóÑÔ∏è–í –∞—Ä—Ö–∏–≤</button>`);
    } else {
      actions.push(`<button class="actionbtn accent" data-act="restore">‚Ü©Ô∏è–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>`);
      actions.push(`<button class="actionbtn neutral" data-act="rename">‚úèÔ∏è–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>`);
    }
    actions.push(`<button class="actionbtn ghost" data-act="close">–ó–∞–∫—Ä—ã—Ç—å</button>`);

    els.sheetActions.innerHTML = actions.join("");

    els.overlay.classList.add("show");
    els.sheet.classList.add("show");

    // bind actions
    els.sheetActions.querySelectorAll("[data-act]").forEach(btn=>{
      btn.addEventListener("click", async (ev)=>{
        ev.stopPropagation();
        const act = btn.getAttribute("data-act");
        if (!act) return;

        if (act==="close"){ closePlantSheet(); return; }

        try{
          if (act==="rename"){
            const cur = state.plants.find(x=>x.id===state.sheetPlantId);
            const name = prompt("–ù–æ–≤–æ–µ –∏–º—è —Ä–∞—Å—Ç–µ–Ω–∏—è:", cur ? cur.name : "");
            if (!name) return;
            await apiFetch(`/api/plants/${state.sheetPlantId}`, {method:"PATCH", body: JSON.stringify({name})});
            toast("‚úÖ–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ");
            closePlantSheet();
            await loadPlants();
          }
          if (act==="norm"){
            const cur = state.plants.find(x=>x.id===state.sheetPlantId);
            const v = prompt("–ù–æ—Ä–º–∞ –ø–æ–ª–∏–≤–∞ (–≤ –¥–Ω—è—Ö). –ü—É—Å—Ç–æ = —É–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É.", cur && cur.water_every_days!=null ? String(cur.water_every_days) : "");
            if (v === null) return;
            const days = v.trim()==="" ? null : Number(v);
            if (days !== null && (!Number.isFinite(days) || days<=0 || days>365)) { alert("–í–≤–µ–¥–∏ —á–∏—Å–ª–æ 1‚Äì365"); return; }
            await apiFetch(`/api/plants/${state.sheetPlantId}/norm`, {method:"PATCH", body: JSON.stringify({days})});
            toast("‚úÖ–ù–æ—Ä–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
            closePlantSheet();
            await loadPlants();
          }
          if (act==="archive"){
            if (!confirm("–£–±—Ä–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ –∞—Ä—Ö–∏–≤?")) return;
            await apiFetch(`/api/plants/${state.sheetPlantId}/archive`, {method:"POST"});
            toast("üóÑÔ∏è–í –∞—Ä—Ö–∏–≤–µ");
            closePlantSheet();
            await loadPlants();
          }
          if (act==="restore"){
            await apiFetch(`/api/plants/${state.sheetPlantId}/restore`, {method:"POST"});
            toast("‚úÖ–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            closePlantSheet();
            await loadPlants();
          }
        }catch(e){
          showError(els.plantsError, e && e.message ? e.message : "–û—à–∏–±–∫–∞");
          closePlantSheet();
        }
      });
    });
  }

  function closePlantSheet(){
    state.sheetPlantId = null;
    els.sheet.classList.remove("show");
    els.overlay.classList.remove("show");
    els.sheetActions.innerHTML = "";
  }


  async function loadPlants(){
    state.plantsLoading = true;
    renderPlants();
    try{
      const q = state.plantsMode==="active" ? "true" : "false";
      const data = await apiFetch(`/api/plants?active=${q}`, {method:"GET"});
      state.plants = Array.isArray(data.items) ? data.items : [];
      state.plantsLoading = false;
      renderPlants();
    }catch(e){
      state.plantsLoading = false;
      showError(els.plantsError, e && e.message ? e.message : "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      renderPlants();
    }  }

  async function addPlant(){
    const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è:");
    if (!name) return;
    clearError(els.plantsError);
    try{
      await apiFetch(`/api/plants`, {method:"POST", body: JSON.stringify({name})});
      toast("‚úÖ–î–æ–±–∞–≤–ª–µ–Ω–æ");
      await loadPlants();
    }catch(e){
      showError(els.plantsError, e && e.message ? e.message : "–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
    }
  }

  // -------- NORMS --------
  function renderNorms(){
    clearError(els.normsError);
    if (state.normsLoading){
      els.normsList.innerHTML = `<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>`;
      return;
    }
    if (!state.norms.length){
      els.normsList.innerHTML = `<div class="empty">–ù–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π —Å –∑–∞–¥–∞–Ω–Ω–æ–π –Ω–æ—Ä–º–æ–π.</div>`;
      return;
    }
    els.normsList.innerHTML = state.norms.map(p=>{
      return `
        <div class="card" style="cursor:default">
          <div class="top">
            <div class="name">${escapeHtml(p.name || "")}</div>
            <span class="badge ok">${p.water_every_days} –¥–Ω–µ–π</span>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn2" data-act="edit" data-id="${p.id}">‚úèÔ∏è–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn2 danger" data-act="clear" data-id="${p.id}">üßπ–£–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É</button>
          </div>
        </div>
      `;
    }).join("");

    els.normsList.querySelectorAll("[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const id = Number(btn.getAttribute("data-id"));
        if (!id) return;
        try{
          if (act==="edit"){
            const cur = state.norms.find(x=>x.id===id);
            const v = prompt("–ù–æ–≤–∞—è –Ω–æ—Ä–º–∞ (–≤ –¥–Ω—è—Ö):", cur ? String(cur.water_every_days) : "");
            if (v === null) return;
            const days = Number(v);
            if (!Number.isFinite(days) || days<=0 || days>365) { alert("–í–≤–µ–¥–∏ —á–∏—Å–ª–æ 1‚Äì365"); return; }
            await apiFetch(`/api/plants/${id}/norm`, {method:"PATCH", body: JSON.stringify({days})});
            toast("‚úÖ–ù–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
            await loadNorms();
          }
          if (act==="clear"){
            if (!confirm("–£–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É?")) return;
            await apiFetch(`/api/plants/${id}/norm`, {method:"PATCH", body: JSON.stringify({days: null})});
            toast("‚úÖ–ù–æ—Ä–º–∞ —É–±—Ä–∞–Ω–∞");
            await loadNorms();
          }
        }catch(e){
          showError(els.normsError, e && e.message ? e.message : "–û—à–∏–±–∫–∞");
        }
      });
    });
  }

  async function loadNorms(){
    state.normsLoading = true;
    renderNorms();
    try{
      const data = await apiFetch(`/api/norms`, {method:"GET"});
      state.norms = Array.isArray(data.items) ? data.items : [];
      state.normsLoading = false;
      renderNorms();
    }catch(e){
      state.normsLoading = false;
      showError(els.normsError, e && e.message ? e.message : "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      renderNorms();
    }  }

  
  // helpers
  function daysLeftText(p){
    try{
      const norm = p && p.water_every_days!=null ? Number(p.water_every_days) : null;
      const lastIso = p && p.last_watered_at ? p.last_watered_at : null;
      if (norm==null || !lastIso) return null;
      const last = new Date(lastIso);
      if (isNaN(last.getTime())) return null;
      const now = new Date();
      const ms = now.getTime() - last.getTime();
      const daysSince = Math.floor(ms / (1000*60*60*24));
      const left = norm - daysSince;
      if (left >= 0) return `–¥–æ –ø–æ–ª–∏–≤–∞ ‚Äî ${left} –¥–Ω–µ–π`;
      return `–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ‚Äî ${Math.abs(left)} –¥–Ω–µ–π`;
    }catch(e){ return null; }
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }
  function formatDate(iso){
    try{
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "‚Äî";
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}.${mm}.${yy}`;
    }catch(e){ return "‚Äî"; }
  }

  // bindings
  els.tabToday.addEventListener("click", ()=>{ setScreen("today"); loadToday(); });
els.tabPlants.addEventListener("click", ()=>setScreen("plants"));
  if (els.tabNorms) els.tabNorms.addEventListener("click", ()=>setScreen("norms"));

  els.btnWater.addEventListener("click", markWatered);  els.plantsActive.addEventListener("click", ()=>{
    state.plantsMode="active";
    els.plantsActive.classList.add("active");
    els.plantsArchived.classList.remove("active");
    loadPlants();
  });
  els.plantsArchived.addEventListener("click", ()=>{
    state.plantsMode="archived";
    els.plantsArchived.classList.add("active");
    els.plantsActive.classList.remove("active");
    loadPlants();
  });
  els.btnAddPlant.addEventListener("click", addPlant);

  // sheet close handlers
  els.overlay.addEventListener("click", closePlantSheet);
  els.sheet.addEventListener("click", (e)=>{ if (e.target===els.sheet) closePlantSheet(); });
  document.addEventListener("keydown", (e)=>{ if (e.key==="Escape") closePlantSheet(); });

  els.btnRefreshNorms.addEventListener("click", loadNorms);

  // init
  if (!initData){
    // For local browser usage (non-TG). We still allow UI to render; API may reject.
    toast("‚ÑπÔ∏è–û—Ç–∫—Ä–æ–π –∏–∑ Telegram –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞");
  }

  loadToday();
})();
</script>
</body>

</html>
